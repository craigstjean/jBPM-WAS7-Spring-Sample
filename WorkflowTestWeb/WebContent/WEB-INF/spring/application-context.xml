<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jee="http://www.springframework.org/schema/jee"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:jbpm="http://drools.org/schema/drools-spring"
       xsi:schemaLocation="
	       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
	       http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-3.1.xsd
	       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd
	       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.1.xsd
	       http://drools.org/schema/drools-spring http://anonsvn.jboss.org/repos/labs/labs/jbossrules/trunk/drools-container/drools-spring/src/main/resources/org/drools/container/spring/drools-spring.xsd">
       
    <bean id="entityManagerFactory" class="javax.persistence.Persistence" factory-method="createEntityManagerFactory">
		<constructor-arg type="java.lang.String" value="WorkflowTestUnit" />
	</bean>

	<bean id="transactionManager" class="org.springframework.transaction.jta.WebSphereUowTransactionManager" />
	<tx:annotation-driven transaction-manager="transactionManager" />
	<tx:annotation-driven proxy-target-class="true" />
	
	<!-- Scans the classpath of this application for @Components to deploy as beans -->
	<context:component-scan base-package="com.craigstjean.workflow.service" />
	<context:component-scan base-package="com.craigstjean.workflow.businessobjects" />
	
	<jbpm:kbase id="kbase">
		<jbpm:resources>
			<jbpm:resource type="BPMN2" source="classpath:com/craigstjean/workflow/bpmn/hotel.bpmn" />
		</jbpm:resources>
	</jbpm:kbase>
	
	<jbpm:ksession id="ksession" type="stateful" kbase="kbase">
		<jbpm:configuration>
			<jbpm:jpa-persistence>
				<jbpm:transaction-manager ref="transactionManager" />
				<jbpm:entity-manager-factory ref="entityManagerFactory" />
			</jbpm:jpa-persistence>
		</jbpm:configuration>
	</jbpm:ksession>
	
	<bean name="workItemHandler" class="org.jbpm.process.workitem.wsht.LocalHTWorkItemHandler">
		<constructor-arg ref="ksession" />
	</bean>
	
	<bean id="systemEventListener" class="org.drools.SystemEventListenerFactory" factory-method="getSystemEventListener" />
	
	<bean id="internalTaskService" class="org.jbpm.task.service.TaskService">
		<constructor-arg ref="entityManagerFactory" />
		<constructor-arg ref="systemEventListener" />
	</bean>
	
	<bean id="htTxManager" class="org.drools.container.spring.beans.persistence.HumanTaskSpringTransactionManager">
		<constructor-arg ref="transactionManager" />
	</bean>
	
	<bean id="springTaskSessionFactory" class="org.jbpm.task.service.persistence.TaskSessionSpringFactoryImpl"
			init-method="initialize" depends-on="internalTaskService">
		<property name="entityManagerFactory" ref="entityManagerFactory" />
		<property name="transactionManager" ref="htTxManager" />
		<property name="useJTA" value="true" />
		<property name="taskService" ref="internalTaskService" />
	</bean>
	  
	<bean id="taskService" class="org.jbpm.task.service.local.LocalTaskService" depends-on="internalTaskService">
		<constructor-arg ref="internalTaskService" />
	</bean>
</beans>
